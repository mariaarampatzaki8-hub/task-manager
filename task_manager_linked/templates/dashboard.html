{% extends "base.html" %}
{% block title %}ÎŸÎ¹ ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚ Î¼Î¿Ï…{% endblock %}
{% block content %}

<h1 class="title" style="color:var(--accent)">ğŸ‘‹ Î“ÎµÎ¹Î± ÏƒÎ¿Ï…, {{ user.name }}!</h1>

<!-- Tabs -->
<div class="tabs is-boxed">
  <ul>
    <li class="is-active" data-tab="tasks"><a>ğŸ“‹ Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚</a></li>
    <li data-tab="notes"><a>ğŸ“ Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</a></li>
    <li data-tab="settings"><a>âš™ï¸ Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</a></li>
    <li data-tab="progress"><a>ğŸ“Š Î ÏÏŒÎ¿Î´Î¿Ï‚ ÎŸÎ¼Î¬Î´Î±Ï‚</a></li>
  </ul>
</div>

<!-- -------- TAB: Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚ -------- -->
<div id="tab-tasks" class="tab-content">
  <div class="columns is-multiline mb-5">
    <div class="column is-3">
      <div class="cardish has-text-centered">
        <p class="heading">Î‘Î½Î¿Î¹Ï‡Ï„Î­Ï‚</p>
        <p class="title is-4" style="color:var(--accent)">{{ open_tasks|length }}</p>
      </div>
    </div>
    <div class="column is-3">
      <div class="cardish has-text-centered">
        <p class="heading">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚</p>
        <p class="title is-4 has-text-success">{{ done_tasks|length }}</p>
      </div>
    </div>
  </div>

  <div class="columns">
    <!-- Î‘Î½Î¿Î¹Ï‡Ï„Î­Ï‚ -->
    <div class="column is-6">
      <div class="cardish">
        <h2 class="subtitle">ğŸŸ¡ Î‘Î½Î¿Î¹Ï‡Ï„Î­Ï‚ ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚</h2>
        {% if open_tasks %}
          {% for t in open_tasks %}
            <div class="box" style="border-left:6px solid var(--accent)">
              <p class="mb-2"><strong>{{ t.title }}</strong></p>
              {% if t.description %}<p class="mb-2">{{ t.description }}</p>{% endif %}
              <p class="is-size-7 mb-2">
                {% if t.due_date %}Î ÏÎ¿Î¸ÎµÏƒÎ¼Î¯Î±: {{ t.due_date.strftime('%d/%m/%Y') }}{% endif %}
                {% if t.due_time %} {{ t.due_time.strftime('%H:%M') }}{% endif %}
              </p>
              <progress class="progress is-small is-info" value="{{ t.progress }}" max="100">{{ t.progress }}%</progress>
              <form method="post" action="{{ url_for('update_task_progress', task_id=t.id) }}" class="mt-2 is-flex" style="gap:8px">
                <input class="input" type="number" min="0" max="100" name="progress" value="{{ t.progress }}" style="max-width:100px">
                <button class="button is-light">Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· %</button>
              </form>
              <form method="post" action="{{ url_for('toggle_task', task_id=t.id) }}" class="mt-2">
                <button class="button is-success">âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ</button>
              </form>
            </div>
          {% endfor %}
        {% else %}
          <p>Î”ÎµÎ½ Î­Ï‡ÎµÎ¹Ï‚ Î±Î½Î¿Î¹Ï‡Ï„Î­Ï‚ ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚ ğŸ‰</p>
        {% endif %}
      </div>
    </div>

    <!-- ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚ -->
    <div class="column is-6">
      <div class="cardish">
        <h2 class="subtitle">âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚</h2>
        {% if done_tasks %}
          {% for t in done_tasks %}
            <div class="box" style="border-left:6px solid #22c55e">
              <p class="mb-2"><strong>{{ t.title }}</strong></p>
              <p class="is-size-7 mb-2">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ: {% if t.completed_at %}{{ t.completed_at.strftime('%d/%m/%Y %H:%M') }}{% endif %}</p>
              <progress class="progress is-small is-success" value="{{ t.progress }}" max="100">{{ t.progress }}%</progress>
              <form method="post" action="{{ url_for('toggle_task', task_id=t.id) }}" class="mt-2">
                <button class="button is-warning">â†©ï¸ Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬</button>
              </form>
            </div>
          {% endfor %}
        {% else %}
          <p>Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î¿Î»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- -------- TAB: Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ -------- -->
<div id="tab-notes" class="tab-content" style="display:none;">
  <div class="cardish">
    <h2 class="subtitle">ğŸ“ ÎŸÎ¹ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Î¼Î¿Ï…</h2>
    <form method="post" action="{{ url_for('me_add_note') }}">
      <textarea class="textarea" name="content" rows="3" placeholder="Î“ÏÎ¬ÏˆÎµ ÎµÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚/Ï€Î±ÏÎ±Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚â€¦"></textarea>
      <button class="button is-link mt-2" style="background:var(--accent)">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
    </form>
    {% if notes %}
      <ul class="mt-4">
        {% for n in notes %}
          <li class="mb-4">
            <div class="is-flex is-justify-content-space-between is-align-items-center">
              <div>
                <small class="has-text-grey">{{ n.created_at.strftime('%d/%m/%Y %H:%M') }}</small><br>
                <span id="note-text-{{ n.id }}">{{ n.content }}</span>
              </div>
              <div class="buttons">
                <button class="button is-small is-light" onclick="toggleEdit({{ n.id }})">âœï¸ Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</button>
                <form method="post" action="{{ url_for('me_delete_note', note_id=n.id) }}" onsubmit="return confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·Ï‚;')">
                  <button class="button is-small is-danger">ğŸ—‘ï¸ Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
                </form>
              </div>
            </div>
            <form id="note-form-{{ n.id }}" method="post" action="{{ url_for('me_update_note', note_id=n.id) }}" class="mt-2" style="display:none">
              <textarea class="textarea" name="content" rows="3">{{ n.content }}</textarea>
              <div class="mt-2">
                <button class="button is-small is-link" style="background:var(--accent)">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î±Î»Î»Î±Î³ÏÎ½</button>
                <button type="button" class="button is-small is-light" onclick="toggleEdit({{ n.id }})">Î†ÎºÏ…ÏÎ¿</button>
              </div>
            </form>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="mt-2">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Î±ÎºÏŒÎ¼Î±.</p>
    {% endif %}
  </div>
</div>

<!-- -------- TAB: Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ -------- -->
<div id="tab-settings" class="tab-content" style="display:none;">
  <div class="cardish">
    <h2 class="subtitle">ğŸ”‘ Î‘Î»Î»Î±Î³Î® ÎºÏ‰Î´Î¹ÎºÎ¿Ï</h2>
    <form method="post" action="{{ url_for('me_change_password') }}">
      {% if user.must_change_password %}
        <p class="notification is-warning">ÎŸ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ ÏƒÎ¿Ï… Î­Ï‡ÎµÎ¹ ÎµÏ€Î±Î½Î±Ï†ÎµÏÎ¸ÎµÎ¯ â€” ÏƒÏ…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Î½Î­Î¿.</p>
      {% else %}
        <div class="field">
          <label class="label">Î¤ÏÎ­Ï‡Ï‰Î½ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚</label>
          <input class="input" type="password" name="current_password" required>
        </div>
      {% endif %}
      <div class="field">
        <label class="label">ÎÎ­Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚</label>
        <input class="input" type="password" name="new_password" required>
      </div>
      <div class="field">
        <label class="label">Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·</label>
        <input class="input" type="password" name="confirm_password" required>
      </div>
      <button class="button is-link" style="background:var(--accent)">Î‘Î»Î»Î±Î³Î®</button>
    </form>
  </div>
</div>

<!-- -------- TAB: Î ÏÏŒÎ¿Î´Î¿Ï‚ ÎŸÎ¼Î¬Î´Î±Ï‚ -------- -->
<div id="tab-progress" class="tab-content" style="display:none;">
  <div class="cardish">
    <h2 class="subtitle">ğŸ“Š Î ÏÏŒÎ¿Î´Î¿Ï‚ ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Ï‡ÏÎ·ÏƒÏ„ÏÎ½</h2>

    {% for u in users %}
      {% set tasks = user_tasks.get(u.id, []) %}
      {% set ns = namespace(total=0, count=0) %}
      {% for t in tasks %}
        {% set ns.total = ns.total + (t.progress or 0) %}
        {% set ns.count = ns.count + 1 %}
      {% endfor %}
      {% set avg = (ns.total // ns.count) if ns.count > 0 else 0 %}

      <div class="box" style="border-left:6px solid {{ u.color or '#888' }}">
        <div class="is-flex is-justify-content-space-between is-align-items-center mb-2">
          <h3 class="title is-5" style="margin:0;">
            <span class="tag" style="background:{{ u.color or '#3273dc' }}; color:#fff">{{ u.name }}</span>
          </h3>
          <strong>{{ avg }}%</strong>
        </div>
        <progress class="progress is-small" value="{{ avg }}" max="100">{{ avg }}%</progress>

        {% if tasks %}
          <div class="mt-3">
            {% for t in tasks %}
              <div class="mb-2">
                <p class="mb-1">
                  <strong>{{ t.title }}</strong>
                  <small>({{ t.status }})</small>
                </p>
                <progress class="progress is-small" value="{{ t.progress }}" max="100">{{ t.progress }}%</progress>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="mt-2"><em>Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚</em></p>
        {% endif %}
      </div>
    {% endfor %}

  </div>
</div>

<!-- Tabs JS -->
<script>
  // ÎµÎ½Î±Î»Î»Î±Î³Î® tabs
  document.querySelectorAll('.tabs li').forEach(li => {
    li.addEventListener('click', () => {
      document.querySelectorAll('.tabs li').forEach(x => x.classList.remove('is-active'));
      li.classList.add('is-active');
      document.querySelectorAll('.tab-content').forEach(x => x.style.display='none');
      const tabId = 'tab-' + li.dataset.tab;
      const el = document.getElementById(tabId);
      if(el) el.style.display = 'block';
    });
  });

  // toggle edit Ï†ÏŒÏÎ¼Î±Ï‚ ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·Ï‚
  function toggleEdit(id){
    const form = document.getElementById('note-form-' + id);
    const text = document.getElementById('note-text-' + id);
    if(form.style.display === 'none'){ form.style.display = 'block'; if(text) text.style.display='none'; }
    else { form.style.display = 'none'; if(text) text.style.display=''; }
  }
</script>

{% endblock %}
