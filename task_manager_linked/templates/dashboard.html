{% extends "base.html" %}
{% block title %}Οι εργασίες μου{% endblock %}
{% block content %}

<h1 class="title" style="color:var(--accent)">👋 Γεια σου, {{ user.name }}!</h1>

<!-- Στατιστικά Cards -->
<div class="columns is-multiline mb-5">
  <div class="column is-3">
    <div class="cardish has-text-centered">
      <p class="heading">Ανοιχτές</p>
      <p class="title is-4" style="color:var(--accent)">{{ open_tasks|length }}</p>
    </div>
  </div>
  <div class="column is-3">
    <div class="cardish has-text-centered">
      <p class="heading">Ολοκληρωμένες</p>
      <p class="title is-4 has-text-success">{{ done_tasks|length }}</p>
    </div>
  </div>
  <div class="column is-3">
    <div class="cardish has-text-centered">
      <p class="heading">Σημειώσεις</p>
      <p class="title is-4">{{ notes|length }}</p>
    </div>
  </div>
</div>

<div class="columns">
  <!-- Ανοιχτές -->
  <div class="column is-6">
    <div class="cardish">
      <h2 class="subtitle">🟡 Ανοιχτές εργασίες</h2>
      {% if open_tasks %}
        {% for t in open_tasks %}
          <div class="box" style="border-left:6px solid var(--accent)">
            <p class="mb-2"><strong>{{ t.title }}</strong></p>
            {% if t.description %}<p class="mb-2">{{ t.description }}</p>{% endif %}
            <p class="is-size-7 mb-2">
              {% if t.due_date %}Προθεσμία: {{ t.due_date.strftime('%d/%m/%Y') }}{% endif %}
              {% if t.due_time %} {{ t.due_time.strftime('%H:%M') }}{% endif %}
            </p>
            <progress class="progress is-small is-info" value="{{ t.progress }}" max="100">{{ t.progress }}%</progress>
            <form method="post" action="{{ url_for('update_task_progress', task_id=t.id) }}" class="mt-2 is-flex" style="gap:8px">
              <input class="input" type="number" min="0" max="100" name="progress" value="{{ t.progress }}" style="max-width:100px">
              <button class="button is-light">Ενημέρωση %</button>
            </form>
            <form method="post" action="{{ url_for('toggle_task', task_id=t.id) }}" class="mt-2">
              <button class="button is-success">✅ Ολοκληρώθηκε</button>
            </form>
          </div>
        {% endfor %}
      {% else %}
        <p>Δεν έχεις ανοιχτές εργασίες 🎉</p>
      {% endif %}
    </div>
  </div>

  <!-- Ολοκληρωμένες -->
  <div class="column is-6">
    <div class="cardish">
      <h2 class="subtitle">✅ Ολοκληρωμένες</h2>
      {% if done_tasks %}
        {% for t in done_tasks %}
          <div class="box" style="border-left:6px solid #22c55e">
            <p class="mb-2"><strong>{{ t.title }}</strong></p>
            <p class="is-size-7 mb-2">Ολοκληρώθηκε: {% if t.completed_at %}{{ t.completed_at.strftime('%d/%m/%Y %H:%M') }}{% endif %}</p>
            <progress class="progress is-small is-success" value="{{ t.progress }}" max="100">{{ t.progress }}%</progress>
            <form method="post" action="{{ url_for('toggle_task', task_id=t.id) }}" class="mt-2">
              <button class="button is-warning">↩️ Επαναφορά</button>
            </form>
          </div>
        {% endfor %}
      {% else %}
        <p>Δεν υπάρχουν ολοκληρωμένες.</p>
      {% endif %}
    </div>
  </div>
</div>

<div class="columns">
  <!-- Σημειωματάριο με edit/delete -->
  <div class="column is-6">
    <div class="cardish">
      <h2 class="subtitle">📝 Οι σημειώσεις μου</h2>

      <!-- Προσθήκη νέας -->
      <form method="post" action="{{ url_for('me_add_note') }}">
        <textarea class="textarea" name="content" rows="3" placeholder="Γράψε ερωτήσεις/παρατηρήσεις…"></textarea>
        <button class="button is-link mt-2" style="background:var(--accent)">Αποθήκευση</button>
      </form>

      <!-- Λίστα σημειώσεων με κουμπιά -->
      {% if notes %}
        <ul class="mt-3">
          {% for n in notes %}
            <li class="mb-3">
              <div class="is-flex is-justify-content-space-between is-align-items-center">
                <div>
                  <small class="has-text-grey">{{ n.created_at.strftime('%d/%m/%Y %H:%M') }}</small><br>
                  <span id="note-text-{{ n.id }}">{{ n.content }}</span>
                </div>
                <div class="buttons">
                  <button class="button is-small is-light" onclick="toggleEdit({{ n.id }})">✏️ Επεξεργασία</button>
                  <form method="post" action="{{ url_for('me_delete_note', note_id=n.id) }}" onsubmit="return confirm('Διαγραφή σημείωσης;')">
                    <button class="button is-small is-danger">🗑️ Διαγραφή</button>
                  </form>
                </div>
              </div>

              <!-- Edit form (κρυφό μέχρι να πατηθεί Επεξεργασία) -->
              <form id="note-form-{{ n.id }}" method="post" action="{{ url_for('me_update_note', note_id=n.id) }}" class="mt-2" style="display:none">
                <textarea class="textarea" name="content" rows="3">{{ n.content }}</textarea>
                <div class="mt-2">
                  <button class="button is-small is-link" style="background:var(--accent)">Αποθήκευση αλλαγών</button>
                  <button type="button" class="button is-small is-light" onclick="toggleEdit({{ n.id }})">Άκυρο</button>
                </div>
              </form>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="mt-2">Δεν υπάρχουν σημειώσεις ακόμα.</p>
      {% endif %}
    </div>
  </div>

  <!-- Αλλαγή κωδικού -->
  <div class="column is-6">
    <div class="cardish">
      <h2 class="subtitle">🔑 Αλλαγή κωδικού</h2>
      <form method="post" action="{{ url_for('me_change_password') }}">
        {% if user.must_change_password %}
          <p class="notification is-warning">Ο κωδικός σου έχει επαναφερθεί — συμπλήρωσε νέο.</p>
        {% else %}
          <div class="field"><label class="label">Τρέχων κωδικός</label><input class="input" type="password" name="current_password" required></div>
        {% endif %}
        <div class="field"><label class="label">Νέος κωδικός</label><input class="input" type="password" name="new_password" required></div>
        <div class="field"><label class="label">Επιβεβαίωση</label><input class="input" type="password" name="confirm_password" required></div>
        <button class="button is-link" style="background:var(--accent)">Αλλαγή</button>
      </form>
    </div>
  </div>
</div>

<script>
  function toggleEdit(id){
    const form = document.getElementById('note-form-' + id);
    const text = document.getElementById('note-text-' + id);
    if(form.style.display === 'none'){ form.style.display = 'block'; text.style.display='none'; }
    else { form.style.display = 'none'; text.style.display=''; }
  }
</script>

{% endblock %}
